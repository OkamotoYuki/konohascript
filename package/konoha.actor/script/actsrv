using konoha.proc.*;

Proc actsrv_p;

@Around void System.exit(int status) {
	if (actsrv_p != null) {
		actsrv_p.terminate();
	}
	proceed(status);
}

void main(String[] actsrv_args)
{
	int actsrv_port = 2000;
	if (|actsrv_args| > 0) {
		actsrv_port = (to int)actsrv_args[0];
	}

	OUT << "start an ActorServer with port: " + (to String)actsrv_port << EOL;
	actsrv_p = new Proc([$konoha.bin.path, $konoha.script.path + "/mailbox.k", (String)actsrv_port]);
	InputStream actsrv_ins = actsrv_p.getInputStream();
	String actsrv_recvmsg = "";
	while (actsrv_p.isAlive()) {
		String actsrv_line = actsrv_ins.readLine();
		if (actsrv_line == "" && actsrv_recvmsg != "") {
			System.eval(actsrv_recvmsg);
			actsrv_recvmsg = "";
		} else if (actsrv_line != "") {
			actsrv_recvmsg += actsrv_line + EOL;
		}
	}
}
